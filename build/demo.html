<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test harness for filter-tree.js</title>

    <style>
        * {
            outline: none;
        }
        body {
            font-family: sans-serif;
        }
        p {
            font-size: smaller;
        }
        textarea {
            display: block;
            margin: 1em 0;
            width: 100%;
        }
        input[type='button'] {
            border: 0;
            background-color: #777;
            color: white;
            font-weight: bold;
            border-radius: 10px;
            padding: 4px 10px;
            letter-spacing: 1px;
            font-family: monospace;
            border: 1px transparent solid;
            box-sizing: border-box;
        }
        input[type='button']:active {
            background-color: #bbb;
            color: black;
            border: 1px #555 solid;
        }
        fieldset {
            margin-bottom: 1.5em;
            background-color: #f4f4f4;
            padding-top: .75em;
            border-radius: 5px;
            box-shadow: 4px 4px 10px #aaa;
        }
        legend {
            font-size: smaller;
            font-style: italic;
            background-color: ivory;
            border: 1px #555 solid;
            padding: 3px 8px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px grey;
        }
        td {
            vertical-align: top;
            padding: .5em;
            width: 50%;
        }
        fieldset > p {
            font-style: italic;
            font-size: smaller;
            margin: .5em 0 0 0;
        }
        .false, .true {
            font-weight: bold
        }
        .false:before {
            color: #c00;
            content: 'exclude';
        }
        .true:before {
            color: #0a0;
            content: 'include';
        }
    </style>
    <script src="filter-tree.js"></script>

    <script>
var filterTree;

window.onload = function() {
    filterTree = new FilterTree({
        fields: getJSON('json-columns'),
        state: getJSON('json-data')
    });
    document.getElementById('filter').appendChild(filterTree.el);

    if (!filterTree.validate({ alert: false }))
    {
        document.getElementById('SQL').value = filterTree.toSQL();
        document.getElementById('test-result').className = filterTree.test(getJSON('json-test'));
    }
};

function initialize() {
    var newTree = new FilterTree({
        fields: getJSON('json-columns'),
        state: getJSON('json-data')
    });
    document.getElementById('filter').replaceChild(newTree.el, filterTree.el);
    filterTree = newTree;
}

function getJSON(id) {
    var value = document.getElementById(id).value;
    try {
        var x;
        return eval('x = ' + value);
    } catch(e) {
        alert('Bad data!');
    }
}

function validate() {
    return filterTree.validate();
}

function toJSON() {
    var valid = !filterTree.validate();
    if (valid) {
        document.getElementById('JSON').value = JSON.stringify(filterTree, null, 3);
    }
    return valid;
}

function fromJSON() {
    filterTree.fromJSON(getJSON('json-data'));
}

function toSQL() {
    var valid = !filterTree.validate();
    if (valid) {
        document.getElementById('SQL').value = filterTree.toSQL();
    }
    return valid;
}

function test() {
    var valid = !filterTree.validate();
    if (valid) {
        document.getElementById('test-result').className = filterTree.test(getJSON('json-test'));
    }
    return valid;
}

// You can make a new filter editor by extending FilterLeaf. The following code patches two existing methods but is highly dependent on the existing code. A more reliable approach would be to override the two methods completely -- rather than extending them (which is essentially what we're doing here by calling them first).

var DefaultEditor = FilterTree.prototype.editors.Default;

FilterTree.prototype.addEditor('Columns', {
    name: 'Column ? Column',
    newView() {
        // Create and insert the three elements into .el
        DefaultEditor.prototype.newView.call(this);

        // Refer to the first element as `column1` instead of `column`
        this.controls.column1 = this.el.firstElementChild;
        delete this.controls.column;

        // Clone the first element and call it `column2`
        this.controls.column2 = this.el.firstElementChild.cloneNode(true);
        delete this.controls.argument;

        // Replace the 3rd element with the clone. There are no event listeners to worry about.
        this.el.replaceChild(this.controls.column2, this.el.children[2]);
    },
    p: function(dataRow) { return dataRow[this.column1]; },
    q: function(dataRow) { return dataRow[this.column2]; },
    toSQL: function() {
        return [
            this.SQL_QUOTED_IDENTIFIER + this.column1 + this.SQL_QUOTED_IDENTIFIER,
            this.sqlOperator,
            this.SQL_QUOTED_IDENTIFIER + this.column2 + this.SQL_QUOTED_IDENTIFIER
        ].join(' ');
    }
});
    </script>
</head>
<body>
<table style="width:100%"><tr><td>

<fieldset>
    <legend>Columns list (hierarchy implies optgroups)</legend>
    <input type="button" value="initialize()" onclick="initialize()" />
    <textarea id="json-columns" rows="6">[
    { options: ['LastName', 'FirstName'], label: 'Names' },
    'BirthState',
    { name: 'DOB', alias: 'Date Of Birth', type: 'date' },
    { name: 'Age', type: 'number' }
]</textarea>
</fieldset>

<fieldset>
    <legend>JSON filter expression</legend>
    <input type="button" value="toJSON()" onclick="toJSON()" />
    <input type="button" value="fromJSON()" onclick="fromJSON()" style="float:right" />
    <textarea id="json-data" rows="6">{
   "operator": "op-and",
   "children": [
      {
         "column": "LastName",
         "operator": "=",
         "argument": "Clinton"
      },
      {
         "operator": "op-or",
         "children": [
            {
               "column": "DOB",
               "operator": "<",
               "argument": "1/1/1950"
            },
            {
               "column": "Age",
               "operator": "=",
               "argument": "69"
            },
            {
               "column": "BirthState",
               "operator": "=",
               "argument": "Arkansas"
            }
         ]
      }
   ]
}</textarea>
</fieldset>

<fieldset>
    <legend>SQL WHERE clause filter expression</legend>
    <input type="button" value="toSQL()" onclick="toSQL()" style="margin-right:10em" />
    <textarea id="SQL" rows="3"></textarea>
</fieldset>

<fieldset>
    <legend>Data row to test against</legend>
    <input type="button" value="test()" onclick="test()" /> &#x27f9;
    <span id="test-result"></span><br/>
    <p>Row data:</p>
    <textarea id="json-test" rows="6" style="margin-top:0">{
    LastName: 'Clinton',
    DOB: '1/19/1946',
    Age: 69
}</textarea>
</fieldset>

</td>
<td>

    <fieldset id="filter" style="white-space:nowrap; height:635px">
        <legend>Filter UI</legend>
        <input type="button" value="validate()" onclick="validate()" style="float:right" />
    </fieldset>

</td>
</tr></table>
</body>
</html>
