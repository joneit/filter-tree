<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test harness for filter-tree.js</title>

    <style>
        * {
            outline: none;
        }
        body {
            font-family: sans-serif;
        }
        textarea {
            display: block;
            margin: 1em 0 3px 0;
            width: 100%;
        }
        input[type='button'] {
            border: 0;
            background-color: #777;
            color: white;
            font-weight: bold;
            border-radius: 10px;
            padding: 4px 10px;
            letter-spacing: .5px;
            font-family: monospace;
            border: 1px transparent solid;
            box-sizing: border-box;
        }
        input[type='button']:active {
            background-color: #bbb;
            color: black;
            border: 1px #555 solid;
        }
        fieldset {
            margin-bottom: 1.5em;
            background-color: #f4f4f4;
            padding-top: .75em;
            border-radius: 5px;
            box-shadow: 4px 4px 10px #aaa;
        }
        legend {
            font-size: smaller;
            font-style: italic;
            background-color: ivory;
            border: 1px #555 solid;
            padding: 3px 8px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px grey;
        }
        td {
            vertical-align: top;
            padding: .5em;
            width: 50%;
        }
        fieldset > p {
            font-size: 8pt;
            margin: 0;
        }
        .false, .true {
            font-weight: bold
        }
        .false:before {
            color: #c00;
            content: 'exclude';
        }
        .true:before {
            color: #0a0;
            content: 'include';
        }
        .invalid:before {
            font-style: italic;
            content: '(invalid)';
        }
    </style>
    <script src="filter-tree.js"></script>

    <script>
var filterTree;
var quietValidation = {alert: false, focus: false};

function autotest() {
    if (document.getElementById('autoget').checked) {
        toJSON(quietValidation);
    }
    getSqlWhereClause();
    test();
}

function makeNewTree() {
    return new FilterTree({
        fields: getLiteral('fields'),
        json: document.getElementById('json-data').value,
        eventHandler: autotest
    });
}

window.onload = function() {
    try {
        filterTree = makeNewTree();
    } catch(e) {
        if (!(e instanceof SyntaxError)) { throw e; }
        alert('Bad JSON format:\n\n' + e);
        return;
    }

    document.getElementById('filter').appendChild(filterTree.el);

    if (!filterTree.validate({ alert: false }))
    {
        document.getElementById('SQL').value = filterTree.getSqlWhereClause();
        test();
    }
};

function initialize() {
    try {
        var newTree = makeNewTree();
    } catch(e) {
        if (!(e instanceof SyntaxError)) { throw e; }
        alert('Bad JSON format:\n\n' + e);
        return;
    }

    document.getElementById('filter').replaceChild(newTree.el, filterTree.el);
    filterTree = newTree;
}

function getLiteral(id) {
    var value = document.getElementById(id).value;
    try {
        var x;
        return eval('x = ' + value);
    } catch(e) {
        alert('Bad ' + id + ' JavaScript literal!');
    }
}

function validate() {
    return filterTree.validate();
}

function toJSON(validateOptions) {
    var valid = !filterTree.validate(validateOptions);
    if (valid) {
        filterTree.JSONspace = 3; // make it pretty
        document.getElementById('json-data').value = filterTree.getJSON();
    }
    return valid;
}

function fromJSON() {
    try {
        filterTree.setJSON(document.getElementById('json-data').value);
    } catch(e) {
        if (!(e instanceof SyntaxError)) { throw e; }
        alert('Bad JSON format:\n\n' + e);
        return;
    }
    test();
}

function getSqlWhereClause(force) {
    if (force || (document.getElementById('autowhere').checked && !filterTree.validate(!force && quietValidation))) {
        document.getElementById('SQL').value = filterTree.getSqlWhereClause();
        console.log()
    }
}

function test(force) {
    if (force || document.getElementById('autotest').checked) {
        document.getElementById('test-result').className = filterTree.validate(!force && quietValidation)
            ? 'invalid'
            : filterTree.test(getLiteral('dataRow'));
    }
}

// You can make a new filter editor by extending FilterLeaf. The following code patches two existing methods but is highly dependent on the existing code. A more reliable approach would be to override the two methods completely -- rather than extending them (which is essentially what we're doing here by calling them first).

var DefaultEditor = FilterTree.prototype.editors.Default;

FilterTree.prototype.addEditor('Columns', {
    name: 'column : column',
    newView() {
        // Create and insert the three default elements (column, operator, value) into .el
        DefaultEditor.prototype.newView.call(this);

        // Refer to the first element as `column1` instead of `column`
        this.controls.column1 = this.el.firstElementChild;
        delete this.controls.column;

        // Clone the first element and call it `column2`
        this.controls.column2 = this.el.firstElementChild.cloneNode(true);
        delete this.controls.value;

        // Replace the 3rd element with the clone. There are no event listeners to worry about.
        this.el.replaceChild(this.controls.column2, this.el.children[2]);

        //TODO: Remove string operators
    },
    p: function(dataRow) { return dataRow[this.column1]; },
    q: function(dataRow) { return dataRow[this.column2]; },
    getSqlWhereClause: function() {
        return [
            this.SQL_QUOTED_IDENTIFIER + this.column1 + this.SQL_QUOTED_IDENTIFIER,
            this.op.sql,
            this.SQL_QUOTED_IDENTIFIER + this.column2 + this.SQL_QUOTED_IDENTIFIER
        ].join(' ');
    }
});
    </script>
</head>
<body>
<table style="width:100%"><tr><td>

    <fieldset>
        <legend>Initialize with a column list</legend>
        <input type="button" value="initialize({ fields: ..., json: filterJSON })" onclick="initialize()" />
        <textarea id="fields" rows="6">[
    { options: ['LastName', 'FirstName'], label: 'Names' },
    'BirthState',
    { name: 'DOB', alias: 'Date Of Birth', type: 'date' },
    { name: 'Age', type: 'number' }
]</textarea>
    <p>Format: JavaScript array literal</p>
    </fieldset>

    <fieldset>
        <legend>filterJSON</legend>
        <input type="button" value="... = filter.getJSON()" onclick="toJSON()"
         title="Generate JSON describing the filter expression in the UI."/>
        <label style="float:right; font-size:10pt"
         title="Automatically regenerate the JSON on any manual change to the UI.">
            <input type="checkbox" id="autoget" onclick="if(this.checked)toJSON()"/>Auto
        </label>
        <textarea id="json-data" rows="6">{
   "operator": "op-and",
   "children": [
      {
         "column": "LastName",
         "operator": "=",
         "value": "Clinton"
      },
      {
         "operator": "op-or",
         "children": [
            {
               "column": "DOB",
               "operator": "<",
               "value": "1/1/1950"
            },
            {
               "column": "Age",
               "operator": "=",
               "value": "69"
            },
            {
               "column": "BirthState",
               "operator": "=",
               "value": "Arkansas"
            }
         ]
      }
   ]
}</textarea>
        <p>Format: JSON (strict, with all property names and values in double-quotes)</p>
        <input type="button" value="filter.setJSON(...)" onclick="fromJSON()" style="margin-top:.7em"
               title="Regnerate the UI based on the filter expression described by the JSON." />
    </fieldset>

    <fieldset>
        <legend>SQL WHERE clause filter expression</legend>
        <input type="button" value="... = getSqlWhereClause()" onclick="getSqlWhereClause(true)" />
        <label style="float:right; font-size:10pt"
         title="Automatically regenerate the SQL on any manual change to the UI.">
            <input type="checkbox" id="autowhere" checked onclick="if(this.checked)getSqlWhereClause()"/>Auto
        </label>
        <textarea id="SQL" rows="3"></textarea>
    </fieldset>

    <fieldset>
        <legend>Data row to test against</legend>
        <input type="button" value="test(dataRow)" onclick="test(true)" /> &#x27f9;
        <label style="float:right; font-size:10pt"
         title="Automatically retest this data row against the filter expression in the UI on any manual change to same.">
            <input type="checkbox" id="autotest" checked onclick="if(this.checked)test()"/>Auto
        </label>
        <span id="test-result"></span><br/>
        <textarea id="dataRow" rows="6">{
    LastName: 'Clinton',
    DOB: '1/19/1946',
    Age: 69
}</textarea>
    <p>Format: JavaScript object literal</p>
    </fieldset>

</td><td>

    <fieldset id="filter" style="white-space:nowrap; height:635px">
        <legend>Filter UI</legend>
        <input type="button" value="validate()" onclick="validate()" style="float:right" />
    </fieldset>

</td></tr></table>
</body>
</html>
